<!DOCTYPE html>

<html>
<body>
  <h1>Audio Recorder</h1>
  <h2>Status <span id="status">Connecting</span></h2>

  <div style="width:500px; height:100px; border: solid thin black;">
    <div id="volume" style="height:100%;background-color:green;" />
  </div>
  <button id="btnToggle">start</button>
  <input type="text" value="DNK" id="txtName"/>

  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script type="text/javascript" src="main.js"></script>
  <script>
    var btn = document.getElementById("btnToggle");
    btn.onclick = function() {
      if (btn.innerHTML == "start") {
        audioprocess.start();
        btn.innerHTML = "stop";
      } else {
        audioprocess.stop();
        btn.innerHTML = "start";
      }
    }

    audioprocess.onconnecterror = function(evt) {
      document.getElementById("status").innerHTML = "Error";
    }

    var levels = [];
    audioprocess.transmit = function(nb) {
      var element = document.getElementById('volume');
      element.style.width = (100 * nb) + '%';

      levels.push(nb);

      if (levels.length == 10) {
        var name = 'ZZZ' + document.getElementById('txtName').value;

        $.post('/in', {
          'source': name.substring(name.length - 3, name.length),
          'levels': levels
        });

        levels = [];
      }
    }

    audioprocess.success = function() {
      document.getElementById("status").innerHTML = "Listening";
      btn.click();
    }

  </script>

</body>
</html>
